#ifndef DISPLAY_AVERAGE_H
#define DISPLAY_AVERAGE_H

#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include "Fonts/FreeMono9pt7b.h"
#include "Fonts/Org_01.h"

extern Adafruit_SSD1306 display;

static const unsigned char PROGMEM beatSmall_bmp[] = {
    0x03, 0xC0, 0xF0, 0x06, 0x71, 0x8C, 0x0C, 0x1B, 0x06, 0x18, 0x0E, 0x02,
    0x10, 0x0C, 0x03, 0x10, 0x04, 0x01, 0x10, 0x04, 0x01, 0x10, 0x40, 0x01,
    0x10, 0x40, 0x01, 0x10, 0xC0, 0x03, 0x08, 0x88, 0x02, 0x08, 0xB8, 0x04,
    0xFF, 0x37, 0x08, 0x01, 0x30, 0x18, 0x01, 0x90, 0x30, 0x00, 0xC0, 0x60,
    0x00, 0x60, 0xC0, 0x00, 0x31, 0x80, 0x00, 0x1B, 0x00, 00, 0x0E, 0x00,
    0x00, 0x04, 0x00
};

static const unsigned char PROGMEM beatBig_bmp[] = {
    0x01, 0xF0, 0x0F, 0x80, 0x06, 0x1C, 0x38, 0x60, 0x18, 0x06, 0x60, 0x18,
    0x10, 0x01, 0x80, 0x08, 0x20, 0x01, 0x80, 0x04, 0x40, 0x00, 0x00, 0x02,
    0x40, 0x00, 0x00, 0x02, 0xC0, 0x00, 0x08, 0x03, 0x80, 0x00, 0x08, 0x01,
    0x80, 0x00, 0x18, 0x01, 0x80, 0x00, 0x1C, 0x01, 0x80, 0x00, 0x14, 0x00,
    0x80, 0x00, 0x14, 0x00, 0x80, 0x00, 0x14, 0x00, 0x40, 0x10, 0x12, 0x00,
    0x40, 0x10, 0x12, 0x00, 0x7E, 0x1F, 0x23, 0xFE, 0x03, 0x31, 0xA0, 0x04,
    0x01, 0xA0, 0xA0, 0x0C, 0x00, 0xA0, 0xA0, 0x08, 0x00, 0x60, 0xE0, 0x10,
    0x00, 0x20, 0x60, 0x20, 0x06, 0x00, 0x40, 0x60, 0x03, 0x00, 0x40, 0xC0,
    0x01, 0x80, 0x01, 0x80, 0x00, 0xC0, 0x03, 0x00, 0x00, 0x60, 0x06, 0x00,
    0x00, 0x30, 0x0C, 0x00, 0x00, 0x08, 0x10, 0x00, 0x00, 0x06, 0x60, 0x00,
    0x00, 0x03, 0xC0, 0x00, 0x00, 0x01, 0x80, 0x00
};

static void hd_rightAlign(const char* text, int y)
{
    int16_t x1, y1;
    uint16_t w, h;

    display.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);

    int startX = display.width() - (w + x1 + 2);
    display.setCursor(startX, y);
    display.println(text);
}

void updateHeartDisplay(int avgBpm, int avgSpo, bool validSpo, bool beatNow, long irValue)
{
    display.clearDisplay();
    display.setTextColor(WHITE);

    // Labels
    display.setFont(&Org_01);
    display.setTextSize(1);

    display.setCursor(2, 15);  display.println("BPM");
    display.setCursor(2, 50);  display.println("SPO");
    display.setCursor(2, 7);   display.println("AVG");
    display.setCursor(2, 42);  display.println("AVG");

    // Numeric fields
    display.setFont(&FreeMono9pt7b);
    display.setTextSize(2);

    char bufBpm[12];
    if (irValue > 50000)
        snprintf(bufBpm, sizeof(bufBpm), "%d", avgBpm);
    else
        snprintf(bufBpm, sizeof(bufBpm), "0", avgBpm);

    hd_rightAlign(bufBpm, 26);

    char bufSpo[12];
    if (validSpo)
        snprintf(bufSpo, sizeof(bufSpo), "%d", avgSpo);
    else
        snprintf(bufSpo, sizeof(bufSpo), "---");

    hd_rightAlign(bufSpo, 60);

    // Heart animation
    if (beatNow)
        display.drawBitmap(28, 20, beatSmall_bmp, 24, 21, WHITE);
    else
        display.drawBitmap(25, 16, beatBig_bmp,   32, 32, WHITE);

    // Divider lines
    display.drawLine(0, 32, 20, 32, 1);
    display.drawLine(60, 32, 128, 32, 1);

    display.display();
}

#endif // DISPLAY_AVERAGE_H
